## Multi-task Shape Regression for Medical Image Segmentation

> MICCAI 2016

### Abstract

​	本文中，我们提出一个多任务形状回归（*Multi-Task Shape Regression*,MTSR）的通用分割框架，该框架将分割当作多任务学习，以利用其联合解决多任务（通过捕获任务相关性增强）的优势。MTSR通过多任务回归完全估计形状轮廓上所有点的坐标，其中对每个坐标的估计对应一个回归任务；MTSR可以联合处理图像外观和形状之间的非线性关系并通过编码坐标相关性捕获整体的形状信息，这使得可以估计高度变化的形状，即使是边界模糊或区域不一致。MTSR完成了一个长期需要的通用框架，不依赖于任何特定假设或初始化，这使得灵活而全自动的分割成为可能，如同时分割多目标，多模态。MTSR在多种图像上六个代表性应用中进行了验证，达到了一致的高性能，dice相似系数（DSC）达到0.93，在每个应用中都比state-of-the-art表现出色，展示了对于医学图像分割的有效性和泛化性。

### 1. Introduction

​	分割是医学图像分析中基础的角色，一直以来都是挑战性的任务，由于多模态应用的多样性，多目标图像外观的巨大变化以及复杂解剖结构的高度形状变化性。但是，传统的分割方法由于缺少泛化性（通常是特定应用，特定模态，为单一目标设计，不能同时分割多个目标）不能在一个框架中解决所有这些挑战。而且，它们通常需要初始化，并依赖于形状轮廓由清晰边界和区域一致性所支持的假设，这由于解剖结构的重叠，复杂的图像纹理和外观（特别是存在病理时）并不总是成立。

​	形状回归最近在医学图像分割中展现了杰出的有效性，比传统方法的性能有巨大提升。核心思想是直接通过回归估计形状轮廓上点的坐标，即，寻找一个非线性回归器将非刚体形状与图像外观联系起来。相比于传统的分割方法，形状回归可以利用先进的机器学习技术来从标注数据集中提取知识，从而解决巨大的形状变化。而且，形状回归摒弃了传统方法手工交互以及初始化，计算上更高效。但是，它还需要解决是在有轮廓离群点时（特别是在边界模糊或区域不一致时），明确的建模形状点坐标相关性，这是形成通用形状回归模型的理论不足。

​	一个通用的形状回归需要同时建模点坐标之间固有的关系以及图像外观和变化形状之间高度复杂的关系。形状轮廓上的点是空间连贯的，统计相关的，这应该被利用来捕获整体形状信息，来恢复边缘或区域一致性不支持的轮廓，已完成鲁棒的形状回归；同时，图像外观和先关形状之间的关系是复杂的非线性，由于图像外观的高度变化以及目标形状的巨大变化，这不能被线性回归模型所解决。

​	本文中，为了解决这些挑战，我们提出一个多任务回归通用分割框架，将分割看作多任务学习，利用其联合解决多任务的优势，即，直接，同时的估计点坐标，通过建模它们之间的关系（即，坐标相关性）来增强。通过包含与结构矩阵相关的潜在空间，MTSR可以通过建模坐标相关性（通过稀疏学习）同时编码整体形状信息以及解决图像外观和形状改变之间的非线性关系（核回归）。

​	本文的主要贡献在于我们第一次通过多任务学习完成通用的形状回归分割框架。相比于之前的方法，MTSR有多种优势。

- 通过执行多任务学习问题，MTSR完成了一个通用形状回归框架，不依赖于特定的假设以及初始化，使得可以分割多种应用中的多个目标，而不用管图像模态。

- 通过稀疏学习明确建模坐标之间的关系，MTSR可以可靠准确的估计每个坐标，从而捕获整体的形状信息，使得可以恢复不受边界或区域一致性支持的轮廓。

- 通过无缝的运用kernel trick，MTSR完成了非线性回归，解决了图像外观变化与形状变化之间的复杂关系。

### 2. Multi-task Shape Regression

​	MTSR将分割作为多任务回归问题，直接同时的估计形状轮廓上的点坐标，每个坐标的估计都是一个回归任务。通过包含一个潜在空间，MTSR通过基于$\ \ell_{2,1}\ $正则化的稀疏学习，以结构矩阵$\ S\ $建模坐标相关性，从而捕获整体形状信息；通过kernelization，MTSR完成kernel回归以有效的解决图像外观和形状变化之间的复杂非线性关系。

#### 2.1 Shape Regression by Multi-task Regression

​	形状回归是直接估计形状轮廓的点坐标，其中形状表示为$\ \mathbb{y}=[h_1,...,h_i,...h_p,v_1,...v_i,...v_p]^\top\ \in\ \mathbb{R}^Q\ $，$\ Q(=2P)\ $为形状轮廓上$\ P\ $个点的坐标数量，$\ h_i\ $和$\ v_i\ $为第$\ i\ $个点的水平和垂直坐标轴。相关的图像由一个特征描述子$\ \mathbb{x}\in\mathbb{R}^d\ $来表示，如，HOG，其中$\ d\ $为维度。

​	MTSR通过多任务回归来直接同时的估计坐标，实现形状回归，同时联合的捕获坐标相关性以获得整体形状信息；它是基于广泛使用的基础多任务回归模型$\ \mathbb{y}=W\mathbb{x}+\mathbb{b}\ $导出的，其中$\ W=[\mathbb{w}_1,...,\mathbb{w}_i,...,\mathbb{w}_Q]^\top\ \in\ \mathbb{R}^{Q\times d}\ $为回归系数，$\ w_i\ \in\ \mathbb{R}^d\ $为$\ y_i\ $的任务参数，$\ b\ \in\ \mathbb{R}^Q\ $为偏置。

#### 2.2 Modeling Correlation by Sparse Learning

​	我们提出建模点坐标之间固有的关系，通过稀疏学习来学得相关点坐标共享的特征。由于轮廓上的点在空间上是一致的，在统计上是相关的，编码相关性可以捕获整体的形状信息，以恢复不受边界或区域一致性支持的轮廓。

​	不像大部分多任务学习算法中直接将正则化加在回归矩阵$\ W\ $上，我们提出包括一个潜在空间。在潜在变量之上，利用结构矩阵$\ S\ $来明确建模坐标关系，通过基于$\ \ell_{2,1}\ $正则化的稀疏学习。基于最小二乘损失函数以及$\ \ell_2\ $正则化，我们的目标函数如下：
$$
\min_{W,S}\frac{1}{\mathcal{N}}\parallel Y-SZ\parallel^2_F\ +\ \lambda\parallel W\parallel^2_F\ +\ \beta\parallel S^\top\parallel_{2,1}
\\s.t.\ \ Z=WX
$$
其中$\ X=[\mathbb{x}_1,\mathbb{x}_2,...,\mathbb{x}_{\mathcal{N}}]\ $,$\ Y=[\mathbb{y}_1,\mathbb{y}_2,...,\mathbb{y}_{\mathcal{N}}]\ $,$\ Z=[\mathbb{z}_1,...,\mathbb{z}_i,...,\mathbb{z}_{\mathcal{N}}]\ \in\ \mathbb{R}^{Q\times\mathcal{N}}\ $，$\ z_i\ \in\ \mathbb{R}^Q\ $为潜在空间中的变量$\ S\ \in\ \mathbb{R}^{Q\times Q}\ $命名为结构矩阵；$\ \ell_{2,1}\ $正则化约束结构矩阵$\ S\ $，使$\ S\ $偏向于列稀疏的；参数$\ \beta\ $控制$\ S\ $的列稀疏程度，大的$\ \beta\ $具有更高的稀疏度；省略了偏置，因为有研究证明偏置可以纳入回归系数$\ W\ $中。

​	由于基于$\ \ell_{2,1}\ $正则化的稀疏学习，形状轮廓上相关坐标的回归器会共享相似的参数稀疏度模式，以捕获潜在空间共同的特征集，即编码了坐标之间的固有关系。因此，整体的形状信息被有效的捕获，使得可以恢复不受 清晰边界和区域一致性支持的坐标，达到更加准确鲁棒的形状估计。而且，可以利用共享特征的相关坐标的知识来提高所有的回归器。通过结构矩阵$\ S\ $来明确的建模坐标相关性，MTSR可以自动的学习形状轮廓上坐标的固有特性，提高了通用性。

​	由于包括了与结构矩阵$\ S\ $相关的潜在空间，MTSR带来了多个优势：

- 潜在空间使用$\ W\ $和$\ S\ $解耦了输入和输出，使其可以有效的解决图像外观变化和形状变化的复杂关系。

- 结构矩阵明确的编码了坐标之间的内在关系，捕获了整体形状信息，使得可以恢复不受边界和区域一致性支持的轮廓。

  由于要分割的目标具有巨大的图像外观变化和高形状变化性，它们之间的关系复杂且高度非线性，不能被线性回归所解决，需要更强力的非线性回归器。

#### 2.3 Kernelization for Nonlinear Regression

​	虽然目标函数（1）不保证$\ W\ $和$\ W\ $同时凸，根据Representer Theorem，由于包括了潜在空间，可以导出关于$\ W\ $和固定$\ S\ $的kernelization。这使得kernel回归来解决图像外观和形状之间的非线性关系，同时可以通过$\ S\ $编码坐标相关性。

​	线性representer theorem在$\ \mathcal{H}\ $为reproducing kernel Hilbert space（RKHS）时非常有用，这简化了经验主义风险最小化问题，从无线维到有限维的优化问题。假设我们将$\ \mathbb{x}_i\ $映射到RKHS中某个$\ \phi(\mathbb{x}_i)\ $有限维度，其中$\ \phi(·)\ $表示$\ \mathbb{x}_i\ $的特征图；映射作为非线性特征提取，可以解决图像外观和形状变化之间的复杂关系。相对应的核函数$\ k(·，·)\ $满足$\ k(\mathbb{x_i},\mathbb{x_j})=\phi(\mathbb{x}_i)^\top\phi(\mathbb{x_j})\ $。为了促进kernelization的求导，我们重写（1）如下：
$$
\min_{W,S}\frac{1}{\mathcal{N}}tr((Y-SWX)^\top(Y-SWX))\ +\ \lambda tr(W^\top W)\ +\ \beta\parallel S^\top\parallel_{2,1}
$$
根据线性representer theorem，我们可以通过下式获得$\ W\ $
$$
W = \alpha\Phi(X)^\top
$$
其中$\ \Phi(X)=[\phi(\mathbb{x}_1),...,\phi(\mathbb{x}_i),...,\phi(\mathbb{x}_{\mathcal{N}})]\ $,$\ \alpha\ \in\ \mathbb{R}^{Q\times\mathcal{N}}\ $。将（3）带入（2）
$$
\min_{\alpha,S}\frac{1}{\mathcal{N}}tr((Y-S\alpha K)^\top(Y-S\alpha K))\ +\ \lambda tr(\alpha K \alpha^\top)\ +\ \beta\parallel S^\top\parallel_{2,1}
$$
其中$\ K=\Phi(X)^\top\Phi(X)\ $为RKHS中的核矩阵。由$\ Z=\alpha K\ $张成的潜在空间由线性变化$\ \alpha\ $级非线性核$\ K\ $获得。作为结果，高层概念被提取，以填充低层特征描述子和形状变化的图像表示之间的语义间隙，使得基于$\ \ell_{2,1}\ $的稀疏学习$\ S\ $可以明确的建模坐标之间的固有关系，捕获整体形状信息。（4）中的目标函数是非凸的，可由alternating优化解决。

#### 2.4 Training and Prediction

​	在训练阶段，MTSR使用轮廓标注数据训练；在预测阶段，给定输入$\ \mathbb{x}_t\ $,由$\ \hat{\mathbb{y}}_t=S\alpha K_t\ $预测形状轮廓的点坐标，其中$\ K_t=\Phi(X)^T\phi(\mathbb{x}_t)\ $。分割结果基于预测的形状轮廓。

### 3. Experiments

​	我们在六个代表性临床图像分割应用中验证了我们的方法，并达到了杰出的效果，DSC到了0.93，比state-of-the-art表现都好。

#### 3.1 Datasets and Implemention Details

![t1](images\t1.png)

​	六个数据集包含了三个公共数据集，前列腺，膝盖和锁骨，以及三个新收集的心脏MR/CT数据集。表1统计了六个数据集的数据。根据[2]，轮廓由目标$\{p_i=(h_i,v_i)|_{i=1:\mathcal{P}}\}$形状上点集$\ \mathcal{P}(=100)\ $来表示。在心脏四个腔中，四个标志点集来指示手动标注，已分别分割心房和心室。使用了HOG描述子，由于其计算搞笑。我们使用DSC（由leave-one-subject-out交叉验证）来与现有方法进行比较。我们比较了MSVR和AKRF两个形状回归模型。mKRR作为多任务学习的baseline。参数$\ \beta\ $由训练集上的交叉验证来获得。

#### 3.2 Results

​	MTSR产生了杰出的效果，证明了其对于医学图像分割的有效性和通用性。定性结果如图1，定量的比较如表2。

![f1](images\f1.png)

![t2](images\t2.png)

**Effectiveness** MTSR的有效性通过克服图像变换以及形状变化（区域不一致性，模糊边界，光照变化，低对比度以及空间/时间非刚体形变）得以证明。如图1所示，*Clavicle:*锁骨的医学部分被其他解剖结构严重掩盖，如纵隔膜和血管，股骨和胫骨软骨都显示出了高的解剖形状变化 ；*Knee:*由于低对比度和形状变化巨大，轮廓是不连续以及不完全可见的。*Prostate:*轮廓没有区域一致性支持，由于复杂的纹理和光照。*Cardiac:*心房和心室展示了空间/时间形变导致的高度变化。但是，如图1，MTSR产生的轮廓紧贴ground trutu，证明了其有效性。

**Generality** MTSR的通用性由解决了多图像多目标，多应用，多模态所展现。这些任务中的图像包含了很宽的医学应用，具有多模态，即MR和CT。但是MTSR可以产生准确的形状轮廓，证明了其有通用性。

**Comparison** 如表2所示，MTSR比state-of-the-art方法最高好4.5%。比MSVR/AKRF以及mKRR要好很多。

### 4. Conclusion

​	在本文中，我们提出了一种通用的分割方法，多目标形状回归（MTSR），它将形状分割形成为一个多任务学习问题。 MTSR能够同时捕获整体形状信息并在单个框架中处理图像外观和可变形状之间的高度非线性关系，这使得能够更精确和可靠地进行形状回归，用于具有多个不同数量的对象的图像分割，而不管模态如何。 对六种不同分割任务的实验表明，MTSR实现了始终如一的高性能，并且明显优于最先进的算法，这证明了其在医学图像分割中的有效性和通用性。