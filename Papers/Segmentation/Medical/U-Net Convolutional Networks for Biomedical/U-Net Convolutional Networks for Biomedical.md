### U-Net: Convolutional Networks for Biomedical Image Segmentation

#### Abstract

​	成功训练深度网络需要大量的标注训练样本。本文提出一种网络结构和训练策略，该训练策略依赖于数据增强的强大使用，以更加有效的利用可用的标注样本。网络结构包含一个收缩(contracting)路径用于捕获上下文，一个对称拓展(expanding)路径以准确定位。我们证明了这种网络可以用很少的图像端到端训练并在ISBI挑战（在电子显微镜下分割神经元结构）中优于先前最好的方法。利用同样的网络结构在投射光学显微镜图像上训练，我们以较大优势赢得了ISBI细胞跟踪挑战。并且，网络计算很快。在GPU上分割一张512x512的图像不到一秒。

#### 1. Introduction

​	在过去的两年中，深度卷积网络在许多视觉识别任务上已经比state-of-the-art表现要好。虽然卷积网络已经存在了很长时间，但却受限于可用的训练集数量以及考虑的网络数量。Krizhevsky等的突破(AlexNet)归功于使用一百万ImageNet 训练样本有监督训练8层大型网络，上百万的参数。之后，更大更深的网络也可以被训练。

​	卷积网络的典型应用是图像分类，其中每张图像的输出为一个类别标签。但是，在许多视觉任务中，尤其是生物医学图像处理，需要的输出包括定位，即，类别标签应该分配到每个像素。而且，在生物医学任务中，通常没有大量的训练图像。因此，Ciresan等在滑动窗口设置中训练了一个网络，通过输入像素周围的局部区域来预测该像素的类别标签。首先，该网络可以定位。其次，以块(patch)为训练数据比以图像训练多很多。该网络赢得了ISBI 2012 EM分割挑战。

​	显然，Ciresan等的策略有两个缺点。首先，运行速度很慢，因为要每个块分别运行，重叠部分有很多冗余。其次，有定位准确度和上下文使用的权衡。大的块需要更多的最大池化层，这会降低定位准确度，而小的块使网络只能看到一小部分上下文。最近的方法提出了分类器输出，考虑了多个层的特征。准确的定位和上下文的使用可以同时进行。

​	本文中，我们使用全卷积网络结构[9]。我们修改并拓展了其结构使其可以使用少量训练图像产生更加准确的分割；如图1.[9]中的思想是通过连续层来补充通常的网络，其中池化操作被替换为上采样操作。因此，这些层增加了输出的分辨率。为了定位，压缩(contracting)路径中的高分辨率特征与上采样输出相结合。连续的巻积层则可以学习根据这些信息组合更准确的输出。

![f1](images\f1.png)

​	我们结构的一个重要改进就是在上采样部分，我们也具有大量的特征通道，这使得网络可以将上下文信息传播至高分辨率层。因此，拓展路径或多或少与压缩路径对称，产生了U形结构。网络没有全连接层并且只利用每个卷积的有效部分，即，分割图只包含输入图像中全部上下文可用的像素。该策略允许通过重叠-拼接策略来对任意大图像进行无缝分割（见图2）。为了预测图像边界区域的像素，缺失的上下文可通过镜像输入图像推测出来。这种拼接策略对于网络应用于大图像很重要，否则分辨率会受限于GPU内存。

![f2](images\f2.png)

​	对于我们的任务，只有少量可用的训练数据，我们通过对训练图像应用弹性变形来增强数据。这使得网络可以学得对于该形变的不变性，而不需要从标注图像库中获得。这对于生物医学分割尤其重要，因为变形是组织中最常见的变化并且现实中的变形可以有效的模拟出来。数据增强用于学习不变性的价值可以从Dosovitskiy等无监督特征学习的研究中得知。

​	细胞分割任务中另一个挑战是分离同类互相接触的物体。见图3。为此，我们提出加权损失，其中相接触细胞间分离的背景标签会在损失函数中获得较大的权重。

![f3](images\f3.png)

​	我们的网络可应用于多种生物医学分割问题。本文中，我们展示了对EM中神经元结构分割（ISBI2012开始的比赛）的结果。而且，我们展示了光学显微镜图像（ISBI细胞跟踪挑战2015）下的细胞分割结果。我们在两个最具挑战的2D透射光数据集上大幅获胜。

#### 2. Network Architecture

​	网络结构如图1所示。包含了一个压缩路径（左边）以及一个拓展路径（右边）。压缩路径与典型卷积网络结构一致。包含了两个3x3卷积（没有padding），ReLU，2x2最大池化（步长为2）。拓展路径中的每一步包含对特征图的上采样，然后进行2x2卷积（上卷积），减半特征通道数量，连接压缩路径中对应裁剪的特征图，接着两个3x3卷积，ReLU。裁剪很必要，因为在每次卷积中边界像素都会丢失。最后一层使用了1x1卷积将每个64分量的特征向量映射到需要的类别数量。网络总共有23个巻积层。

​	为了对输出分割图无缝剪裁（见图2），选择输入大小，使得所有2x2最大池化操作都应用于具有相等的x和y的层。

#### 3. Training

​	输入图像和它们对应的分割图被用来训练网络，使用Caffe实现的随机梯度下降法。由于卷积操作没有padding，输出图像比输入小固定的宽度。为了最小化开销以及最大化GPU内存的使用，我们更喜欢大的输入块(tile)而不是大的批数量，因此将batch减少到单张图像。据此，我们设置高动量(0.99)，这样大量先前见过的训练样本决定了当前优化步骤的更新。

​	能量函数通过在最后特征图上逐像素softmax来计算并结合交叉熵损失函数。softmax定义为$\ p_k(x)=exp(a_k(x))/(\sum^K_{k'=1}exp(a_{k'}(x)))\ $，其中$\ a_k(x)\ $表示在特征通道$\ k\ $，对像素位置$\ x\in\Omega\ $的激活（$\ \Omega\subset\mathbb{Z^2}\ $）。$K\ $为类别数，$\ p_k(x)\ $为近似最大值函数，即，$\ k\ $具有最大激活$\ a_k(x)\ $则$\ p_k(x)\approx1\ $，否则$\ p_k(x)\approx0\ $。交叉熵会惩罚每个位置$\ p_{\ell(x)}(x)\ $与1的偏差，公式如
$$
E = \sum_{x\in\Omega}w(x)log(p_{\ell(x)}(x))
$$
其中$\ \ell：\Omega\to\{1,...,K\}\ $为每个像素的真实标签，$\ w:\Omega\to\mathbb{R}\ $为加权图，让某些像素在训练中更重要。

​	我们先计算了每个ground-truth分割的权重图，以补偿在训练数据集中某个类别像素不同的频率，并使得网络可以学到相接触的细胞间小的分离边界（见图3c和d）。使用形态学操作来计算分离边界。权重图计算公式如下

$$
w(x)=w_c(x)+w_0\cdot exp(-\frac{(d_1(x)+d_2(x))^2}{2\sigma^2})
$$
其中$w_c:\Omega\to\mathbb{R}$为平衡类别频率的权重图，$d_1:\Omega\to\mathbb{R}$表示与最近的细胞边界之间的距离，$d_2:\Omega\to\mathbb{R}$表示与第二近的细胞边界之间的距离。在我们的实验中，设置$w_0=10$，$\sigma\approx5$像素。

​	在具有许多巻积层和不同路径的深度网络中，权重的初始化尤其重要。否则，一部分网络可能基于过多的激活，而里其他部分没有作用。理想情况下，初始权重应该被调整，使得网络中每个特征图具有相似的单位方差。在我们的网络结构中，可以通过从高斯分布（标准差为$\sqrt{2/N}$,N表示神经元输入结点的数量，如一个3x3卷积和前一层64个特征通道，$N=9\cdot64=576$）中提取初始权重来达到。

##### 3.1 Data Augmentation

​	当只有很少的训练样本可用时，数据增强对于教会网络不变性和鲁棒性很重要。在显微镜图像中，我们主要需要平移和旋转不变性以及对形变和灰度值变换的鲁棒性。特别是训练样本的随机弹性形变对于以少量标注数据训练分割网络是关键概念。我们在粗3x3网格上使用随机位移变量来生成平滑形变。

​	位移从高斯分布（10像素标准差）中采样。然后使用双三次插值计算每个像素的位移。压缩路径最后的Drop-out层则执行隐式的数据增强。

#### 4. Experiments

​	我们展示了U-Net在三个分割任务中的应用。第一个任务是在电子显微镜记录中分割神经元结构。数据集和分割结果如图2所示。在补充材料中我们提供了完整结果。数据集由EM分割挑战提供，ISBI2012开始，依然接受新的贡献。训练数据为30张果蝇第一龄幼虫腹神经束(VNC)的序列切片透射电镜图像 （512x512像素）。每张图像都有对应的标注ground truth分割图，细胞（白色），细胞膜（黑色）。测试集没有分割图。可以发送预测的细胞膜概率图到主办方以评估结果。评估是以10个不同级别在图上进行二值化(thresholding)来计算“warping 误差”，“Rand误差”，“pixel误差”。

​	U-Net在没有前处理或后处理的情况下，达到了warping误差0.0003529，rand误差0.0382（见表1）。

![t1](images\t1.png)

这比Ciresan等的滑窗卷积网络结果要好很多。在rand误差方面，该数据集上唯一更好的算法是在Ciresan等的概率图上应用数据集-特定的后处理方法达到的。

![t2](images\t2.png)

​	我们也将U-Net应用于光学显微镜图像的细胞分割任务。这一分割任务是ISBI细胞跟踪挑战2014和2015的一部分。第一个数据集PhC-U373 2包含了由相衬显微术记录的聚丙烯酰胺基板上的胶质母细胞瘤-星形细胞瘤U373细胞（见图4a,b和补充材料）。它包含了35张部分标注的训练图像。这里我们达到了平均IOU92%，比第二的83%好很多（见表2）。 第二组数据集DIC-HeLa 是用差示干涉对比(DIC)显微镜记录在平板玻璃上的HeLa细胞 （见图3，图4c,d和补充材料）。它包含了20张部分标注的训练图像。这里我们达到了平均IOU77.5%，比第二的算法46%要好很多。

![f4](images\f4.png)

#### 5. Conclusion

​	U-Net结构在不同的生物医学分割应用中达到了很好的性能。由于对弹性形变的数据增强，它只需要很少的标注图像，训练时间在NVIDIA TITAN GPU上为10小时。