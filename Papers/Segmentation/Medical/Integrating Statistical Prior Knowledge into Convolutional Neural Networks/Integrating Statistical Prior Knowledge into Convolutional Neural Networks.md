## Integrating Statistical Prior Knowledge into Convolutional Neural Networks

> MICCAI 2017 Fausto Milletari 是VNet作者

### Abstract 

​	本文中我们展示了如何集成先验统计信息（通过主成分分析获得，PCA）到卷积神经网络中，以获得鲁棒的预测，即使是处理损坏的或噪声数据。我们的网络是端到端训练的，包含了一个特别设计的层可以组合通过PCA发现的数据集变化模式，并通过对其的线性组合来产生预测结果。我们也提出了一种关注CNN在特定感兴趣区域上attention的机制，以获得精确的结果。我们展示了我们的方法在分割任务和标志（landmark）定位任务中很有效。

### 1. Introduction and Related Work

​	过去的十年中，有很多使用PCA的方法被提出来执行医学图像分割和注册任务。

​	当使用固定数量的控制点来表示形状时，PCA可以用来构建点分布模型（PDM），通过在训练集中寻找形状变化的主要模式。接着分割算法可以依靠图像数据和先验知识来训练一个符合形状模型的轮廓。分割结果在解剖学上是正确的，即使是图像数据不足或因噪声和人工不可靠时。这些方法被叫做活动形状模型（ASM），可以应用于很多问题。如[1]中，通过颅骨颞骨窗口超声图像中一个脑部几乎不可见的部分，可以使用3D活动轮廓可靠的分割出来。

​	其他的一些方法将活动形状模型的优点与活动外观模型联合起来。在[12]中，使用3D活动外观模型分割了心脏体积超声和MRI图像。这些方法的缺点是很难定义优化的能量函数使得在几百次迭代优化后可以正确适当的分割轮廓。

​	最近的一些方法，主要是基于机器学习，利用了隐式的先验信息以及高级的手工或学习的特征，以克服之前基于优化的技术的限制。在[11]中，训练了一个随机Hough森林来定位和分割心脏左心室。形状模型的概念通过投票和分割策略强加的约束来实现，该策略依赖于将训练中出现的部分ground truth轮廓重新映射到未见过的样本上。该思想在[8]中得以拓展。

​	基于深度学习的方法最近被提出用于医学图像分析。利用全卷积网络进行分割来处理2D图像和体积图像。这些方法没有用到任何统计形状模型，只依赖于卷积神经网络大的感知域可以一次感知感兴趣解剖，因此不太可能的形状只会在很少的MRI或纤维图像下被预测。一种有趣的方法[7,9]融合了Hough投票和CNNs，被应用于脑部扫描的超声图像和MR图像。尽管Hough-CNN可以得到准确的结果，但其设计不能端到端训练。

​	本文中，我们提出将PCA获取的统计先验包括进卷积神经网络。我们的PCA层组合了数据的变化模式并以这些模式的线性组合来产生预测。这一过程被应用于关注CNN后续层在特定感兴趣区域上的attention的进程，以产生精确的预测。重要的是，形状编码入PCA层，网络可以端到端训练，损失加在点的最后位置。以这种方式，我们想克服之前深度学习方法缺少强形状先验的限制以及活动形状模型缺少高级模式识别能力的限制。我们的方法是全自动的，因此与之前大部分基于ASM，需要交互的方法不同。网络在单一步骤中输出预测结果，不需要优化循环。

​	我们将该方法应用于两个挑战性超声图像分析任务。在第一个任务中，形状建模提高了2D超声心动图（从胸骨长轴视图PLA获得）标志定位的准确率。在第二个任务中，算法提高了左心室分割的dice系数。

### 2. Method

​	给定训练集包含$\ N\ $幅图像$\ I={I_1,...,I_N}\ $以及对应ground truth$\ Y={y_1,...,y_N}\ $,$\ y_i\in\mathbb{R}^{2P}\ $包含了P个关键点的坐标，P个关键点描绘了标志（landmarks）的位置。我们使用训练集首先获得$\ Y\ $中坐标变化的主要模式，接着训练一个CNN来利用它。为了对比CNN层细粒度细节的损失，我们提出了一个机制，关注网络在全分辨率细节上的attention，通过剪裁部分图像提高预测结果（图1和图2）。我们的结构是端到端训练，网络所有的参数都会在每次迭代中更新。

![f1](images\f1.png)

![f2](images\f2.png)

#### 2.1 Building a Shape Model Through PCA

​	大部分自然形成的结构，如器官和身体的解剖细节，不会任意变化：不同形状部分或解剖标志之间存在对称性和相关性。主成分分析（PCA）可以被用来发觉数据集中变化的主要模式。当我们使用整个数据集中对齐的点集来描述形状时，PCA揭示了不同点间存在的相关性，并定义了一个新的坐标框架，主要的变化模式与坐标轴相对应。首先，我们减去每个形状$\ y_i\ $中每个形状点的平均值	.
$$
\check{y}_i=y_i-\mu, \mathrm{with}\ \mu=\frac{1}{N}\sum_iy_i
$$

我们接着将数据集中所有样本按列堆叠$\ \{y_i\}\ $的方式构建矩阵$\ \check{Y}\ $。最后，我们计算协方差矩阵$\ \check{Y}\check{Y}^{\top}\ $的特征向量。这在下式中与$\ U\ $相对应。
$$
\check{Y}=U\Sigma V^{\top}
$$
可以通过奇异值分解获得（SVD）。矩阵$\ \Sigma\ $为对角矩阵，包含元素$\ \{\sigma^2_1,..,\sigma^2_K\}\ $，为协方差矩阵的特征值，表示了在特征基中每个主成分相关的方差。

​	数据集中任意样本可以通过主成分的线性组合综合起来。
$$
y_i=Uw+\mu
$$
线性组合的每个系数不仅决定一个点的位置，还决定多个相关的点，即描述形状。对加权每个主成分影响的系数施加约束，或减少其数量直到保留方差的百分比与达到的主成分数量之间有正确的平衡，可以合成形状，与之前介绍的“合法形状”概念相关。

#### 2.2 Network Architecture

​	本文使用CNN，如图1所示，来使用矩阵$\ U\ $存储的主成分来执行预测。

​	我们不训练CNN来执行公式3中权值$\ w\ ​$的回归，而是利用一种端到端结构：网络直接使用PCA特征基，以关键点位置的形式来预测图像$\ I_i\ ​$中的结果$\ \check{y_i}\in\mathbb{R}^{2P}\ ​$。这对训练处理有直接的结果。网络通过最小化损失$\ l=\sum_i\parallel\check{y}_i-y_i\parallel^2_2\ ​$学习，在知道其对结果的影响的同时掌握系数。每个权值$\ w_j\ ​$实际上同时控制多个相关关键点。由于预测是主成分的线性组合获得，它们遵从“合法形状”的概念，也因此对对数据，噪声以及手工鲁棒。

​	我们的网络包含两个分支。第一个分支利用卷积，池化和全连接层，并通过PCA来产生关键点位置的粗略估计。第二个分支在从输入图像中粗关键点位置周围裁剪的全分辨率块上操作。第二个网络的输出通过更细粒度的视觉信息细化了第一个网络的预测。两个分支同时训练并且完全可微分。全部卷积没有应用padding，第一个CNN分支使用3x3的尺寸，第二个浅层使用5x5的尺寸。所有PCA层的输入都没有通过非线性变换。

​	我们的PCA层实现了公式3的轻微修改版本。除了由网络全连接层提供的权重$\ w\ $外，我们也提供了全局变化，应用于所有预测点。通过二维向量$\ s\ $我们可以处理感兴趣解剖的变换。我们可以将修改的公式3表示为
$$
y_i=Uw+\mu+s
$$
​	执行剪裁的层遵循了[6]中空间变换器的实现，保证了可微性。常规的采样模式是转换到粗略关键点位置，周围区域的强度值使用双线性插值。有$\ P\ $个关键点我们获得mini-batch$\ K\ $个图像中每个图像的$\ P\ $个块。产生的$\ KP\ $个块接着通过3层卷积网络来处理（8个filter，没有padding），总共减少12个像素的尺寸。在巻积层之后，各个块又被排列成一批$\ K\ $个元素，8x$\ P\ $个通道，接着通过3个全连接层，最后计算$\ w_A\ $，与$\ w\ $维度一直。在PCA层应用的精细的权值$\ w_F\ $，以获得更准确的关键点预测，可以由$\ w_F=w_A+w\ $获得。

### 3. Results

​	我们在两个人类心脏超声数据集上测试了我们的方法。我们的目标解决两个不同的任务。第一个任务是分割左心室，第二个任务是标志定位问题，其中需要定位图像中14个感兴趣点。在第一种情况下，我们的模型利用了感兴趣结构的形状统计先验信息，第二种情况下我们的模型捕获不同病人的心脏周期中的标志之间的时空间关系。对于分割任务，我们用了1100张标注数据，953用于训练，147用于测试。标志定位任务中用706个样本训练网络，在47张图像上测试。第二个任务总共使用的标注图像为753。训练和测试病人没有重叠。所有的标注都是由专家完成。

​	我们的python实现依赖Tensorflow框架。所有的实验在Nvidia Tesla K80 GPU，12G视频内存，16G线程以及四核Intel CPU上进行。处理一张图不到一秒钟。

#### 3.1 Segmentation

​	我们以32个对应关键点（使用周期性三次B-样条插值获得）来表示感兴趣形状。结果是勾画左心室的闭合曲线。我们与以下方法比较了我们的结果：

（1）与我们主分支结构相似的CNN，没有应用PCA，只是简单回归了标志位置，没有加约束。

（2）U-Net网络，预测分割mask，值在0到1之间，以0.5为阈值。

我们训练这些结构100epoch。结果如表1所示。

![t1](images\t1.png)

图3中我们报道了测试集上Dice 得分的分布。

![f3](images\f3.png)

#### 3.2 Landmark Localization

​	标志定位任务的结果如表2所示。形状建模PCA层引入了约束，可以提高评估的准确度。相比于回归点位置的全连接CNN，明确的形状约束更好的指导了单个评估点的相对位移。

![t2](images\t2.png)

### 4. Conclusion

​	我们提出了一种方法，将先验形状约束加入到深度神经网络中。这由主成分分析层来实现，可以从形状变化模式的线性组合中计算预测结果。预测结果被用来掌握后续巻积层的attention，以精细预测的估计。

​	提出的结构提高了分割结果和多种评估的鲁棒性和准确度。我们在左心室超声扫描上的实验展示了跟高的最小化dice系数（相比于回归点位置的CNN以及预测前景概率图的U-Net）。我们在心脏结构多评估上的结果展示了更少的误差。