### V-Net:Fully Convolutional Neural Networks for Volumetric Medical Image Segmentation

#### Abstract

​	卷积神经网络（CNNs）最近被应用于解决计算机视觉和医学图像分析领域。尽管它们的流行，大部分方法只能处理2D图像而大部分临床实践中的医学数据为3D体数据。本文提出一种方法，基于体积的，全卷积神经网络进行3D图像分割。我们的CNN在前列腺MRI体数据上端到端训练，并学习一次预测整个volume的分割。我们引入一个新的目标函数，基于Dice系数，在训练时进行优化。以这种方式我们可以处理前背景数量不平衡的情况。为了解决可用训练数据有限的问题，我们通过非线性变换和直方图匹配来增强数据。实验评估显示了我们的方法在挑战性测试数据上达到了很好的性能，而处理时间比之前的方法要少。

#### 1. Introduction

​	最近计算机视觉和模式识别上的研究突显了卷积神经网络的能力，在许多挑战任务上达到了state-of-the-art性能，如分类，分割以及目标检测。这些成功归功于CNN对原始输入数据层级表示的学习能力，而不依赖于手工特征。随着网络各层对输入的处理，输出特征的抽象性不断提升。浅层捕获局部信息而深层使用具有更宽感受野的滤波器，可以捕获更多全局信息。

​	分割是医学图像分割高度相关的任务。自动勾画器官以及感兴趣结构通常对于执行视觉增强，计算机辅助诊断，干预以及从图像中提取量化指标等任务很重要。但是，相比于计算机视觉中常用的2D图像，医学领域的诊断和介入数据通常是体积的。这急需要算法执行3D的分割，通过一次考虑全部体积内容。

​	本文中，我们目的在于分割前列腺MRI体数据。这一任务在诊断期间（如，由于体积评估）以及治疗计划期间（如，通过准确边界估计）具有临床意义。MRI的前列腺分割具有挑战性，因为不同扫描间外观变化剧烈，如，在形变方面或强度分布变化方面。而且，MRI体数据通常由于磁场不均匀性而受到人工和失真的影响。

​	本文中我们提出了一个新的3D分割方法，利用了全卷积网络，端到端训练，以处理医学体积图像，如MRI。相比于其他方法，我们的贡献分为三点。首先，相比于一个切片一个切片的处理输入的方式，我们提出直接使用3D卷积。第二，我们提出最大化一个新的专为医学图像分割设计的目标函数（基于Dice 重叠系数）。第三，我们将最近的见解整合到改进的训练融合中，通过制定每个卷积阶段使其能学习到一个残差函数。以我们的经验观察到这种机制保证了我们新的结构可以用更少的时间收敛（相比于其他相似的网络应用于Promise 2012数据集）。我们在前列腺MRI测试体数据上展示了快速准确的结果，并提供了与其他方法的比较。

#### 2. Related Work

​	CNNs最近被用于医学图像分割。早期的方法通过执行逐块(patch)的图像分割来获得图像或volumes的解剖结构。这种分割只考虑了局部上下文，因此易失败，特别是在挑战的模态，如超声波。后处理方法如连接组件分析通常不会产生提升，因此最近的工作提出使用网络预测与马尔科夫随机场，投票策略或水平集等相结合。逐块(patch)的方法也存在效率的问题。当CNN处理密集提取的块时，大量的计算是冗余的，因此整体算法运行时间很长。在这种情况下，可以应用更有效的计算模式。CNNs的全连接层在一定条件下可以转换为全卷积层，如[18]中展示的。

​	端到端训练的全卷积网络被应用于计算机视觉和显微镜图像分析中的2D图像。这些模型启发了我们的工作，应用全卷积网络结构，被训练预测分割mask，勾画整幅图像中感兴趣的结构。在[14]中，使用了预训练VGG网络结构与其镜像的，反卷积等效的结构向连接，来分割RGB图像，利用了最内层提取特征的表述能力。在[11]中，三个全卷积网络，在分类任务上预训练，然后微调以产生分割结果。在[17]中，提出了一个新的CNN模型，专为处理2D生物医学图像分析问题。最近，该方法被拓展为3D并应用于共焦显微镜下的体积数据。该方法使用部分标注数据训练，通过优化加权多项式logistic损失层。相比于此，我们提出了一个新的损失层特别为分割任务所设计，该损失基于Dice系数。我们的实验显示直接优化该目标重叠度量会产生比多项损失函数更好的结果。

#### 3. Method

​	图2展示了我们网络的原理结构。我们执行卷积目的在于提取特征以及在每阶段的最后，减少其分辨率。网络左边包含了压缩路径，而右边的部分解压缩信号直到还原原始尺寸。卷积都应用了合适的padding。

![f2](images\f2.png)

​	网络的左侧被分为不同的阶段，操作不同的分辨率。每个阶段包含一到三个巻积层。与[5]中方法类似的，我们制定了每个阶段，使其学得残差函数：每阶段的输入（a）被用于巻积层并通过非线性处理；（b）被加到该阶段最后的巻积层输出，使得可以学得残差函数。如我们经验观察所证实，该结构收敛时间更短。

​	每个阶段执行的卷积使用体积核为5x5x5。随着数据在压缩路径中不同的阶段处理，其分辨率会被减少。这是通过执行2x2x2，stride 2的卷积（图3）。由于第二个操作只考虑非重叠的2x2x2体积块来提取特征，产生的特征图数量就会减半。这一策略与池化层目的相似。而且，由于在压缩路径每一阶段特征通道数量增加了一倍，以及制定的残差网络，我们借助这些卷积操作来翻倍特征图数量，同时减少它们的分辨率。整个网络使用PReLU非线性。

![f3](images\f3.png)

​	使用卷积替换池化操作导致网络，需要特定的实现，在训练时具有更少的内存足迹。这是由于switches（将池化层输出映射回其输入），不需要为反向传播存储。特别的，当使用反卷积而不是反池化操作时，这更容易被理解分析。

​	下采样使我们可以减少输入信号的尺寸，增加后面网络计算特征的感受野。网络左边部分每个阶段都比前一层计算两倍的特征数量。

​	网络右边的部分提取特征并拓展低分辨率特征图的空间支持，以便收集和组合必要的信息来输出两通道体积分割。最后的巻积层具有1x1x1的核，产生与输入体相同的数量，并通过softmax转换为前\背景区域的分割概率。在右边每阶段之后，应用反卷积，以增加输入的尺寸（图3），与左边网络相似的，我们也利用参数函数在卷积阶段。

​	与[17]类似的，我们将左边前面阶段提取的特征传到右边部分。如图2所示的横向连接。我们以这种方式收集在压缩路径中会丢失的细粒度的细节，并提高了最终轮廓预测的质量。我们也观察到这些链接减少了模型收敛的时间。

​	表1展示了每个网络层的感受野，说明了CNN最内层的部分已经捕获了整个输入volume的内容。我们认为这一特性对于几乎不可见的解剖分割很重要：最深层计算的特征可以一次感知整个感兴趣解剖区域，因为他们从具有空间支持（比要勾画的典型解剖尺寸大很多）的数据中计算出来，因此加上了全局约束。

![t1](images\t1.png)

#### 4. Dice loss layer

​	网络的预测包含两个volume，与原始输入图像具有相同尺寸，经过softmax层处理，输出每个体元属于前景和背景的概率。在图像volume中，如本文所处理的，常见的是感兴趣解剖占据扫描的小部分区域。这通常导致网络落入局部最优，使其预测强烈的偏向背景。结果导致前景区域通常被漏掉或只被部分检测到。一些之前的方法采用了基于样本重加权的损失函数，其中前景区域被给予更高的重要性。本文中，我们基于Dice系数（0到1之间，需要最大化的）提出一种新的目标函数。两个volume之间的Dice系数$\ D\ $表示为
$$
D = \frac{2\sum^N_ip_ig_i}{\sum^N_ip^2_i+\sum^N_ig^2_i}
$$
其中求和为N个体元，预测的二元分割volume$\ p_i\in P\ $, groundtruth 二元volume$\ g_i\in G\ $。Dice公式可以求导关于第 j 个预测体元，产生梯度：
$$
\frac{\partial D}{\partial p_j}=2\left[ \frac{(\sum^N_ip^2_i+\sum^N_ig^2_i)-2p_j(\sum^N_ip_ig_i)}{(\sum^N_ip^2_i+\sum^N_ig^2_i)^2} \right]
$$
使用该公式，我们不需要建立前景和背景的平衡。事实上，我们获得了比其他使用重加权的网络更好的结果（图6）。

##### 4.1 Training

​	我们的CNN在前列腺MRI扫描数据上端到端训练。该数据的样例如图1所示。所有的volume尺寸为128x128x64，空间分辨率为1x1x1.5毫米。

![f1](images\f1.png)

​	标注的医学体不容易获得，因为一个或多个专家手工标注可靠的ground-truth花费很高。本文中，我们发现增强原始训练数据集很重要，以在测试数据上获得鲁棒性和高准确度。

​	在每次训练迭代中，通过使用密集的变形场（由2x2x2网格控制点以及B-样条插值获得）来将训练数据随机变形，并将多个变形版本送入网络。在每次优化迭代之前动态执行这些增强，以减轻额外的存储需求。此外，在训练时我们改变数据的强度，以模拟不同扫描仪的数据外观。为此，我们使用直方图匹配来调整每次迭代训练volume的强度分布，以适应数据集其他随机选择的扫描结果。

##### 4.2 Testing

之前没见过的MRI volume可以通过前传入网络的方式来分割。最后巻积层的输出，接着softmax，包含了前景和背景的概率图。voxel具有高前景概率（>0.5）的被认为是解剖结构的一部分。

#### 5. Results

​	我们在50个MRI volume以及对应的ground-truth（PROMISE2012挑战数据集）上训练。该数据集包含了不同医院，不同设备以及不同获取协议的医学图像数据。这个数据集中的数据代表了临床环境中的变化和挑战。如前面说到的，我们通过在每次训练迭代中执行随机变化，大量增强了每个mini-batch数据集。我们的实现中每个mini-batch包含两个volume，主要是因为模型在训练时需要高的内存。我们设置动量为0.99，初始学习率为0.0001，没25K次迭代降低一个数量级。

​	我们在30个MRI volume（没有ground-truth）上测试了V-Net。结果直接通过提交跟个结果获得。这个测试集代表了在真实的临床环境中前列腺扫描中所遇到的临床变化 。

​	我们在Dice 重叠，预测轮廓和ground-truth的Hausdorff距离以及获得的挑战得分评估了我们的方法（如表5，图4）。

![t2](images\t2.png)

![f4](images\f4.png)

​	我们的实现使用python，使用Caffe框架的定制版本（可以执行体积卷积，通过CuDNN v3）。所有的训练和实验在标准工作台进行（64 GB RAM, 3.30GHz Intel R  CoreTM i7-5820K CPU, NVidia GTX 1080 with 8 GB VRAM）。模型训练48小时或大概30K迭代，分割之前未见过的volume大约1秒。首先使用N4偏置场校正函数对数据集进行归一化，然后重新采样至1×1×1.5 mm的通用分辨率。我们将随机变形应用于用于训练的扫描，方法是通过用零均值和15个体素标准偏差的高斯分布获得的随机量来改变控制点的位置。 定性结果如图5所示。

![f5](images\f5.png)

#### 6. Conclusion

​	我们提出了一种体积卷积神经网络，可以高效准确的分割MRI前列腺volume。我们提出一个新的目标函数，在训练时基于Dice重叠系数进行优化。我们的Dice损失层在前背景像素不平衡时不需要采样重加权。我们的结构受到[17]的启发，我们将其分为各个阶段学习残差，根据经验观察，在结果和收敛时间上都有提高。进一步的工作将通过将网络分至多个GPU来分割包含其他模态（如超声波）以及高分辨率的多个区域。

